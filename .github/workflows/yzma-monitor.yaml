name: Monitor External YZMA Release

on:
  workflow_dispatch:
  repository_dispatch:
    types: [external-release]

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: "stable"
      - name: Update dependencies
        run: |
          go get -u -v ./...
          go mod tidy
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet go.mod go.sum; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No dependency changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Dependency changes detected"
            # Extract version changes for release notes
            echo "## Dependency Updates" > /tmp/release_notes.md
            echo "" >> /tmp/release_notes.md
            git diff go.mod | grep "github.com/hybridgroup/yzma" | sed 's/^[+-]//' >> /tmp/release_notes.md
          fi
      - name: Cache test models
        if: steps.check_changes.outputs.changes == 'true'
        id: cache-models
        uses: actions/cache@v4
        with:
          path: models
          key: ${{ runner.os }}-models-v3
      - name: Download test models
        if: steps.check_changes.outputs.changes == 'true' && steps.cache-models.outputs.cache-hit != 'true'
        run: |
          mkdir -p ./models
          curl -Lo ./models/qwen2.5-0.5b-instruct-q8_0.gguf https://huggingface.co/Qwen/Qwen2.5-0.5B-Instruct-GGUF/resolve/main/qwen2.5-0.5b-instruct-q8_0.gguf?download=true
          curl -Lo ./models/Qwen2.5-VL-3B-Instruct-Q8_0.gguf https://huggingface.co/ggml-org/Qwen2.5-VL-3B-Instruct-GGUF/resolve/main/Qwen2.5-VL-3B-Instruct-Q8_0.gguf?download=true
          curl -Lo ./models/mmproj-Qwen2.5-VL-3B-Instruct-Q8_0.gguf https://huggingface.co/ggml-org/Qwen2.5-VL-3B-Instruct-GGUF/resolve/main/mmproj-Qwen2.5-VL-3B-Instruct-Q8_0.gguf?download=true
          curl -Lo ./models/embeddinggemma-300m-qat-Q8_0.gguf https://huggingface.co/ggml-org/embeddinggemma-300m-qat-q8_0-GGUF/resolve/main/embeddinggemma-300m-qat-Q8_0.gguf?download=true
      - name: Run tests
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          export LD_LIBRARY_PATH=$GITHUB_WORKSPACE/libraries
          export CONCURRENCY=1
          export INSTALL_LLAMA=1
          mkdir -p ./libraries
          CGO_ENABLED=0 go test -v -count=1
      - name: Commit changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add go.mod go.sum
          git commit -m "Update yzma dependency to latest version"
          git pull --rebase
          git push
      - name: Create release
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          # Get current version and bump patch version
          LATEST_TAG=$(git tag --sort=-version:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            NEW_TAG="v0.1.0"
          else
            # Parse semantic version and increment patch
            VERSION=${LATEST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            NEW_TAG="v${MAJOR}.${MINOR}.$((PATCH + 1))"
          fi
          
          # Create tag
          git pull --rebase
          git tag -a "$NEW_TAG" -m "Auto-release: yzma dependency update"
          git push origin "$NEW_TAG"
          
          # Create GitHub release with version change notes
          NOTES=$(cat /tmp/release_notes.md 2>/dev/null || echo "Automated yzma dependency update")
          gh release create "$NEW_TAG" \
            --title "Release $NEW_TAG" \
            --notes "$NOTES"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}